# 安全约束终端使用说明文档
本终端是一款具备**强制安全管控**的命令执行工具，核心功能是将所有操作限制在指定工作空间内，通过命令黑白名单、脚本拦截、路径校验等机制，杜绝高危操作与工作空间逃逸，适用于沙箱环境、受限操作场景（如代码编辑、文本处理）等需严格权限控制的场景。


## 1. 工具简介
### 1.1 核心定位
- **工作空间强绑定**：初始化时必须指定工作空间路径，所有命令（目录跳转、文件操作、文本处理、版本控制）均被限制在该空间内，**绝对禁止任何跳出操作**。
- **多层安全防护**：通过“允许命令白名单→脚本执行拦截→逃逸命令检测→禁止命令黑名单→路径范围校验”五级管控，全流程拦截危险操作。
- **状态自动同步**：实时同步当前操作目录，确保目录状态与终端实际会话一致，避免路径伪造漏洞。
- **功能适配扩展**：支持非交互文本处理、内容搜索、代码版本控制等常用场景，同时禁止系统级修改（如软件安装、权限提权）。

### 1.2 适用场景
- 受限环境下的基础文件操作（如查看目录、创建文件、切换子目录）和基础开发操作（文本修改、代码提交、内容搜索）；
- 禁止提权、系统修改、软件安装、批量删除等高危行为的场景；
- 需防止脚本注入、跨目录操作、外部系统影响的安全终端需求。


## 2. 核心安全机制
### 2.1 工作空间绑定与跳出拦截（绝对禁止）
#### 2.1.1 工作空间初始化规则
- 终端启动时必须指定**工作空间路径**（支持相对路径，自动转为绝对路径）；
- 若工作空间不存在，可开启“自动创建”功能生成目录（仅创建空目录，无默认内容）；
- 工作空间绑定后**全程不可修改**，所有命令的路径参数（含文本文件、代码仓库、搜索目标）均会基于此空间校验。

#### 2.1.2 跳出拦截场景（全部拦截，无例外）
终端会解析所有命令的路径参数，对超出工作空间的操作直接拒绝，典型拦截场景包括：
1. **目录跳转拦截**：执行 `cd ../other`（跳转到工作空间外的“other”目录）、`cd /home/outside`（绝对路径跳出）等命令，直接拦截；
2. **文件操作拦截**：执行 `ls /home/outside`（查看外部目录）、`touch ../test.txt`（在外部创建文件）等命令，直接拦截；
3. **目录同步校验**：每次执行 `cd` 后，自动校验当前目录是否在工作空间内，若异常跳出则终止操作并提示错误。
4. **文本处理拦截**：执行 `sed -i 's/旧/新/' /home/outside/test.txt`（修改外部文件）、`cat /etc/config`（查看外部文本）等命令，直接拦截；
5. **搜索操作拦截**：执行 `grep "关键词" /home/outside/`（搜索外部目录）、`grep -r "内容" /var/log`（递归搜索外部日志）等命令，直接拦截；
6. **版本控制拦截**：执行 `git clone https://xxx.git /home/outside/repo`（克隆仓库到外部）、`git pull origin main --work-tree=/home/outside`（拉取到外部目录）等命令，直接拦截。


### 2.2 禁止命令清单（不可绕过）
#### 2.2.1 默认禁止的高危命令（系统级管控）
终端默认拦截以下命令片段，含空格的片段为精确匹配（避免误判同类单词）：

| 禁止命令片段       | 拦截目的                  | 会被拦截的命令示例                   |
|--------------------|---------------------------|--------------------------------------|
| `sudo `、`su `     | 防止提权操作（获取更高权限）| `sudo ls`、`su root`、`sudo touch test.txt` |
| `shutdown`、`reboot` | 防止系统关机/重启        | `shutdown -h now`、`reboot`、`shutdown -r 10` |
| `rm -rf /`、`dd if=/` | 防止磁盘级破坏操作       | `rm -rf /tmp/test`（含`rm -rf /`）、`dd if=/dev/zero of=/test` |
| `mv /`、`cp /`     | 防止根目录操作（影响系统文件）| `mv /home/file ./`（含`mv /`）、`cp /etc/config ./` |
| `rm -rf *`、`rm -rf .*` | 防止批量删除当前/隐藏文件 | `rm -rf *.txt`（含`rm -rf *`）、`rm -rf .*` |
| `apt `、`apt-get `、`yum `、`dnf `、`brew ` | 防止软件安装/系统修改 | `apt install git`、`yum install python`、`brew install wget` |
| `dpkg `、`rpm `    | 防止包管理操作（系统级软件维护）| `dpkg -i xxx.deb`、`rpm -ivh xxx.rpm` |


#### 2.2.2 自定义禁止命令（灵活扩展）
可根据场景追加禁止命令，例如：
- 新增 `chmod `：防止修改文件/目录权限（如 `chmod 777 test.txt`）；
- 新增 `rm -f `：防止强制删除文件（如 `rm -f test.txt`）；
- 新增 `find `：防止通过查找命令间接操作外部文件（如 `find / -name test.txt`）。

#### 2.2.3 禁止命令生效规则
- 黑名单优先级高于白名单：即使命令在“允许列表”中，若包含禁止片段，仍会被拦截；
- 逃逸命令拦截：对嵌套在引号/反引号、管道（`|`）、分号（`;`）中的禁止命令，同样拦截，例如：
  - `bash -c 'sudo ls'`（引号内嵌套`sudo`）；
  - `echo 1 | rm -rf test.txt`（管道后接`rm -rf`）；
  - `ls; sudo touch test.txt`（分号后接`sudo`）。


### 2.3 脚本执行控制（默认禁用）
#### 2.3.1 默认拦截的脚本命令
终端默认禁止所有脚本解释器命令，避免通过脚本绕过安全管控，包括但不限于：
- 编程语言脚本：`python `、`python3 `、`go run `、`node `、`perl `、`ruby `、`php `；
- Shell脚本：`bash `、`sh `、`zsh `、`ksh `、`csh `、`./script.sh`（执行当前目录脚本）、`sh test.sh`；
- 脚本执行参数：`-c`（如 `python -c 'print(1)'`、`bash -c 'grep "key" test.txt'`）。

#### 2.3.2 脚本执行开启规则
仅在**可信环境**中可手动开启脚本执行，开启后仍需通过“命令白名单+路径校验”，禁止执行工作空间外的脚本或调用禁止命令（如脚本内包含`apt install`仍会被拦截）。


### 2.4 安全校验流程（严格遵循）
所有命令执行前必须通过以下五级校验，任意一级失败则拒绝执行：
1. **允许列表校验**：若配置了允许命令，仅包含允许命令的操作可通过（如允许`grep`则`grep "key" test.txt`可通过，`apt`未允许则拒绝）；
2. **脚本执行校验**：默认拦截所有脚本命令，未禁用时才允许脚本相关操作；
3. **逃逸命令校验**：检测是否通过引号、管道、分号嵌套禁止命令；
4. **禁止列表校验**：拦截包含禁止命令片段的操作；
5. **路径范围校验**：确保命令涉及的所有路径（文本文件、搜索目录）均在工作空间内。


## 3. 操作示例
### 3.1 正常操作步骤（工作空间内）
假设工作空间为 `/home/user/safe_ws`，允许命令：`ls`、`cd`、`touch`、`sed`、`grep`、`git`、`cat`、`nl`。

#### 3.1.1 非交互文本处理（指定行修改/查看）
1. **创建文本文件**：执行 `touch code.conf`，在工作空间内生成配置文件；
2. **写入基础内容**：执行 `echo -e "port=8080\nhost=localhost\ndebug=false" >> code.conf`；
3. **指定行查看**：
   - 执行 `cat -n code.conf`（带行号查看全部内容），输出：
     ```
        1  port=8080
        2  host=localhost
        3  debug=false
     ```
   - 执行 `sed -n '2p' code.conf`（仅查看第2行），输出：`host=localhost`；
   - 执行 `nl code.conf`（默认空行不标行号，查看有效内容），输出与`cat -n`类似但过滤空行；
4. **指定行修改**：执行 `sed -i '1s/8080/8000/' code.conf`（将第1行的“8080”改为“8000”）；
5. **验证修改**：执行 `cat code.conf`，输出第1行为`port=8000`。

#### 3.1.2 文本内容搜索（grep）
1. **简单搜索**：执行 `grep "localhost" code.conf`（搜索包含“localhost”的行），输出：`host=localhost`；
2. **带行号搜索**：执行 `grep -n "debug" code.conf`（搜索“debug”并显示行号），输出：`3:debug=false`；
3. **递归搜索目录**：执行 `mkdir src && touch tasking/main.py`，在`tasking/main.py`中写入`print("hello")`，再执行 `grep -r "hello" ./`（递归搜索当前目录下含“hello”的文件），输出：`./tasking/main.py:print("hello")`。

#### 3.1.3 代码版本控制（git）
1. **初始化仓库**：执行 `git init`（在工作空间内初始化git仓库）；
2. **添加文件到暂存区**：执行 `git add code.conf tasking/main.py`；
3. **提交代码**：执行 `git commit -m "init: add config and main.py"`；
4. **查看状态/日志**：
   - 执行 `git status`，输出“nothing to commit, working tree clean”；
   - 执行 `git log`，查看提交记录（显示刚才的“init”提交）。


### 3.2 被拦截的危险操作示例
1. **跳出工作空间（cd外部）**：  
   执行 `cd ../other`，终端提示“cd目标超出工作空间，拒绝执行”；
2. **使用禁止命令（sudo）**：  
   执行 `sudo ls`，终端提示“命令包含禁止操作（sudo ），拒绝执行”；
3. **执行脚本（python）**：  
   执行 `python test.py`，终端提示“命令是脚本执行（已禁用），拒绝执行”；
4. **批量删除（rm -rf *）**：  
   执行 `rm -rf *`，终端提示“命令包含禁止操作（rm -rf *），拒绝执行”。
5. **apt软件安装（默认禁止，可以修改禁止命令放开 apt 安装限制）**：  
   执行 `apt install git`，终端提示“命令包含禁止操作（apt ），拒绝执行”；
6. **跨目录搜索（grep）**：  
   执行 `grep "key" /home/outside/test.txt`，终端提示“操作路径超出工作空间，拒绝执行”；


## 4. 命令权限清单
### 4.1 允许使用的命令（需配置，默认无限制）
建议遵循“最小权限原则”，仅配置必要命令，新增常用命令分类如下：

| 命令类别       | 允许命令列表                                                                 | 用途说明                                                                 |
|----------------|------------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 基础目录操作   | `ls`（含`ls -l`/`ls -a`）、`cd`（子目录）、`mkdir`（含`mkdir -p`）、`du -sh` | 查看目录、切换工作空间内子目录、创建多级目录、查看文件/目录大小           |
| 基础文件操作   | `touch`、`cat`（含`cat -n`）、`cp`（工作空间内）、`mv`（工作空间内/重命名）、`rm`（单个文件） | 创建空文件、查看文件内容、工作空间内复制/移动文件、删除单个文件           |
| 非交互文本处理 | `sed`（含`sed -i`/指定行修改）、`nl`（带行号查看）、`echo -e`（写入内容）   | 非交互修改文本（指定行/替换）、带行号查看文件、批量写入多行内容           |
| 文本搜索       | `grep`（含`grep -n`/`grep -r`）                                             | 搜索文本关键词、带行号搜索、递归搜索工作空间内目录                       |
| 版本控制       | `git init`、`git add`、`git commit`、`git status`、`git log`、`git diff`     | 工作空间内git仓库初始化、暂存/提交文件、查看仓库状态/提交日志/代码差异   |


### 4.2 禁止使用的命令（默认+自定义）
| 命令类别       | 禁止命令列表                                                                 | 拦截原因                                                                 |
|----------------|------------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 系统提权       | `sudo `、`su `、`sudoers`                                                   | 避免获取超出自定义权限，影响系统安全                                     |
| 系统修改       | `apt `、`apt-get `、`yum `、`dnf `、`brew `、`dpkg `、`rpm `                 | 禁止软件安装、系统更新，防止引入外部风险或修改系统配置                   |
| 高危删除       | `rm -rf /`、`rm -rf *`、`rm -rf .*`、`rm -f`                                 | 避免批量删除文件、强制删除或破坏磁盘内容                                 |
| 跨目录操作     | `cd`（外部目录）、`ls`（外部目录）、`grep`（外部路径）、`git clone`（外部仓库） | 防止操作工作空间外的文件/目录，避免数据泄露或外部影响                   |
| 脚本执行       | `python `、`bash `、`sh `、`go run `、`node `、`./script.sh`                 | 禁止通过脚本绕过安全校验，执行未授权操作                                 |


## 5. 注意事项
1. **工作空间不可突破**：  
   任何通过软链接（如 `ln -s /home/outside ./link` 后操作`./link`）、相对路径（如 `grep "key" ../../outside/test.txt`）跳出工作空间的操作，均会被路径校验拦截，无绕过方式。
2. **git操作限制**：  
   允许的`git`命令仅支持“工作空间内已有仓库”的操作，禁止克隆外部仓库到工作空间外，也禁止通过`git --work-tree`指定外部目录。
3. **sed修改安全**：  
   使用`sed -i`（直接修改文件）前，建议先执行无`-i`的预览命令（如 `sed '1s/8080/8000/' code.conf`），确认修改逻辑正确，避免误改重要文件。
4. **grep递归范围**：  
   执行`grep -r`时，默认仅递归工作空间内目录，无需额外指定路径（如 `grep -r "key" ./`），若指定外部路径（如 `grep -r "key" /home`）会被拦截。
5. **资源释放需手动执行**：  
   终端使用完成后，需执行“关闭”操作释放进程资源，避免资源泄漏；若涉及git仓库，建议先执行`git status`确认工作区干净，再关闭终端。
6. **禁止命令不可规避**：  
   即使拆分命令（如 `cmd="sudo"; $cmd ls`）、拼接路径（如 `rm -rf /tmp/../test`），仍会被逃逸检测拦截。