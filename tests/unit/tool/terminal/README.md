# Terminal 和 Filesystem 工具测试驱动文档

# 1. 文档概述

## 1.1 文档目的

本文档为 `LocalTerminal` 类（本地终端实现）和 `FileSystem` 类（文件系统工具）的测试驱动规范，明确"需测试的功能范围、测试用例设计逻辑、执行标准及交付要求"，确保测试覆盖所有核心功能与安全校验点，验证终端类和文件系统工具符合设计预期（如安全边界控制、线程安全、命令合规性、文件操作安全性等）。

## 1.2 测试对象

### 1.2.1 LocalTerminal 类

测试对象为基于 `ITerminal` 抽象接口实现的 `LocalTerminal` 类，核心职责包括：

- 类Unix系统下的长期bash进程管理（启动、执行命令、关闭）；

- 工作空间（workspace）与根目录（root_dir）的边界控制；

- 命令安全校验（白名单、脚本禁用、禁止命令拦截、路径校验等）；

- 线程安全控制与异常处理（超时、进程崩溃等）。

### 1.2.2 FileSystem 类

测试对象为基于 `IFileSystem` 抽象接口实现的 `FileSystem` 类，核心职责包括：

- 基于终端工作空间约束的文件系统操作（文本编辑、文件读取）；

- 行级文本编辑操作（插入、修改、删除）；

- 文件内容读取（支持文本和二进制文件，返回 base64 编码）；

- 终端命令执行能力（复用终端的安全约束）；

- 路径解析与安全校验（确保所有操作在 workspace 内）。

## 1.3 测试依据

- `ITerminal` 和 `IFileSystem` 抽象接口定义的抽象方法契约；

- `LocalTerminal` 和 `FileSystem` 类构造函数及核心方法的设计注释；

- 安全校验规则（如禁止命令正则、路径校验逻辑、脚本禁用规则）；

- 文件系统操作规范（如行号规则、特殊字符转义、目录自动创建等）。

# 2. 测试目标

## 2.1 LocalTerminal 测试目标

1. **功能有效性**：验证终端基础功能（初始化、进程启停、命令执行、目录切换）正常可用；

2. **安全合规性**：验证所有安全校验规则（白名单、脚本禁用、禁止命令、路径控制）有效拦截风险操作；

3. **边界与异常处理**：验证终端对特殊场景（特殊字符路径、复合命令、超时、进程崩溃）的处理符合预期；

4. **线程安全性**：验证多线程并发执行命令时无竞态条件，锁机制有效；

5. **兼容性**：验证终端在支持的类Unix系统（Linux、macOS）上正常运行。

## 2.2 FileSystem 测试目标

1. **功能有效性**：验证文件系统工具基础功能（文件编辑、文件读取、命令执行）正常可用；

2. **文本编辑准确性**：验证行级编辑操作（插入、修改、删除）的准确性和行号处理逻辑；

3. **安全合规性**：验证文件系统工具遵循终端的安全约束（路径校验、命令白名单、脚本禁用）；

4. **边界与异常处理**：验证文件系统工具对特殊场景（特殊字符、Unicode、大文件、路径遍历）的处理符合预期；

5. **集成性**：验证文件系统工具与终端的集成（依赖注入、工作空间共享、安全约束继承）正常工作。

# 3. 测试范围

## 3.0 测试模块概览

测试范围分为两大主要模块：

1. **LocalTerminal 模块**：包含"基础功能模块""安全校验模块""并发与异常处理模块"三大类；

2. **FileSystem 模块**：包含"基础功能模块""文本编辑模块""安全校验模块""边界与异常处理模块"四大类。

具体测试项如下：

## 3.1 基础功能模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|终端初始化|1. 根目录为绝对路径的校验；2. 工作空间（默认/自定义/特殊字符路径）的创建与绑定；3. 初始目录同步至workspace；4. 唯一终端ID生成|功能测试|
|进程启停|1. 进程启动（bash进程创建、PID生成）；2. 重复启动的异常拦截；3. 优雅关闭（stdin关闭→终止信号→超时强制杀死）；4. 关闭后状态重置|功能测试|
|目录切换|1. `cd_to_workspace` 切换至workspace（含特殊字符路径转义）；2. `cd` 命令执行后的目录同步（防篡改，依赖 `_get_real_current_dir`）|功能测试|
|命令执行与输出|1. 简单命令（ls、touch）执行；2. 复合命令（分号/管道连接）执行；3. 命令输出的实时读取与标记过滤（`_COMMAND_DONE_MARKER`）；4. 执行结果的正确性|功能测试|
## 3.2 安全校验模块（核心）

|测试子项|测试内容说明|测试类型|
|---|---|---|
|允许命令白名单校验|1. 白名单非空时，仅允许列表内命令（如仅允许ls/rm时拦截grep）；2. 白名单为空时，允许除禁止命令外的所有命令；3. `allow_by_human=True` 时跳过白名单校验|安全测试|
|脚本执行禁用校验|1. 禁用时拦截脚本解释器（python、bash、go run等）；2. 拦截带路径的脚本解释器（/usr/bin/python、./venv/bash）；3. 拦截直接执行的脚本文件（./test.sh、test.py）；4. `allow_by_human=True` 时跳过脚本拦截|安全测试|
|禁止命令拦截|1. 批量删除拦截（rm -rf *、rm -rf ./*）；2. 跨层级删除拦截（rm -rf ../、rm -rf ../sub_ws）；3. 提权命令拦截（sudo、su、sudoers等变体）；4. 系统危险命令拦截（rm -rf /、shutdown、mkfs）；5. 绝对禁止命令不受 `allow_by_human` 影响|安全测试|
|路径范围校验|1. 所有路径敏感命令（ls、cp、rm等）的路径需在root_dir内；2. rm命令额外限制：仅允许workspace内的精准路径（无*、..）；3. 非rm命令：`allow_by_human=False` 时路径需在workspace内，True时可放宽至root_dir|安全测试|
|逃逸命令拦截|1. 拦截嵌套在引号中的禁止命令（如bash -c 'sudo rm -rf /'）；2. 拦截转义引号嵌套的禁止命令（如bash -c "sudo rm -rf /"）；3. 递归校验嵌套命令内容|安全测试|
## 3.3 并发与异常处理模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|线程安全|1. 多线程并发调用 `run_command`（如10线程同时执行ls）；2. 验证锁机制（RLock）有效，无进程阻塞、输出混乱或数据竞争|性能测试+功能测试|
|异常处理|1. 空命令拦截；2. 命令语法错误（未闭合引号）拦截；3. 命令执行超时（如sleep 3设置超时1秒）；4. 路径不存在/权限不足时的错误提示；5. 终端进程崩溃后的异常抛出|异常测试|

测试用例需遵循"正向验证+反向拦截"原则，即既要验证合法操作正常执行，也要验证非法操作被有效拦截。以下为关键测试用例模板（完整用例集可参考配套的 `test_terminal.py` 和 `test_filesystem.py`）：

## 4.1 基础功能用例模板（以“特殊字符路径切换”为例）

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|FUNC-CWD-001|含特殊字符的workspace切换|1. 系统为Linux/macOS；2. 存在临时根目录 /tmp/test_root|1. 创建含空格+引号的workspace：/tmp/test_root/safe ws'2024；2. 初始化LocalTerminal，绑定该workspace；3. 调用 `cd_to_workspace()`；4. 调用 `get_current_dir()` 查看目录|1. 终端初始化成功；2. 目录切换后，当前目录与workspace路径一致；3. 无路径解析错误（如空格被截断）|高|
## 4.2 安全校验用例模板（以"批量删除拦截"为例）

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|SEC-RM-001|批量删除命令拦截|1. 终端初始化完成，workspace内有测试文件；2. `allow_by_human=False`|1. 执行命令：rm -rf *；2. 查看命令执行结果；3. 验证workspace内文件是否存在|1. 命令被拦截，抛出 `PermissionError`；2. 日志输出"workspace内批量删除"的禁止提示；3. workspace内文件未被删除|最高|

## 4.3 FileSystem 功能用例模板

### 关键边界情况用例 ⚠️ **重要**

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|FUNC-FS-EDIT-001|多行插入编辑操作|1. 文件系统工具初始化完成；2. workspace内存在测试文件 test.txt|1. 创建初始文件，内容为"Line 1\nLine 3"；2. 调用 `edit` 方法，在行2插入"Line 2"；3. 读取文件内容验证|1. 文件内容为"Line 1\nLine 2\nLine 3"；2. 行号正确插入；3. 原有内容未被破坏|高|
|FUNC-FS-EMPTY-001|空文件插入开头操作|1. 文件系统工具初始化完成；2. workspace内存在空文件 empty.txt|1. 创建空文件；2. 调用 `edit` 方法，line=0 插入内容"First Line"；3. 读取文件内容验证|1. 文件内容为"First Line"；2. 使用 `cat` 重定向而非 `sed r` 命令；3. 临时文件正确清理|最高|
|FUNC-FS-EMPTY-002|空文件插入末尾操作|1. 文件系统工具初始化完成；2. workspace内存在空文件 empty.txt|1. 创建空文件；2. 调用 `edit` 方法，line=-1 插入内容"Last Line"；3. 读取文件内容验证|1. 文件内容为"Last Line"；2. 使用 `echo >>` 命令追加；3. 临时文件正确清理|最高|
|FUNC-FS-EMPTY-003|空文件多行插入操作|1. 文件系统工具初始化完成；2. workspace内存在空文件 empty.txt|1. 创建空文件；2. 调用 `edit` 方法，插入包含换行符的多行内容；3. 读取文件内容验证|1. 所有行正确写入文件；2. 使用临时文件处理多行内容；3. 使用 `cat temp > file` 而非 `sed r` 命令|最高|
|FUNC-FS-EMPTY-004|空文件删除操作|1. 文件系统工具初始化完成；2. workspace内存在空文件 empty.txt|1. 创建空文件；2. 调用 `edit` 方法，删除第1行；3. 验证异常处理|1. 抛出 RuntimeError，提示"无法对空文件执行 delete 操作"；2. 文件保持空状态|高|
|FUNC-FS-EMPTY-005|空文件修改操作|1. 文件系统工具初始化完成；2. workspace内存在空文件 empty.txt|1. 创建空文件；2. 调用 `edit` 方法，修改第1行内容；3. 验证异常处理|1. 抛出 RuntimeError，提示"无法对空文件执行 modify 操作"；2. 文件保持空状态|高|

### 临时文件和资源管理用例 ⚠️ **重要**

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|FUNC-FS-TEMP-001|临时文件路径安全性|1. 文件系统工具初始化完成；2. workspace在临时目录中|1. 创建包含特殊字符路径的workspace；2. 执行需要临时文件的操作；3. 验证临时文件位置|1. 临时文件创建在workspace内；2. 不会被创建到系统临时目录；3. 进程ID保证文件名唯一性|最高|
|FUNC-FS-TEMP-002|临时文件名冲突处理|1. 文件系统工具初始化完成；2. 快速连续操作|1. 快速连续执行多个需要临时文件的操作；2. 检查临时文件名生成|1. 使用进程ID避免冲突；2. 多个操作创建不同临时文件；3. 操作完成后文件正确清理|高|
|FUNC-FS-TEMP-003|临时文件泄漏检测|1. 文件系统工具初始化完成；2. workspace干净|1. 执行大量需要临时文件的操作；2. 检查临时文件数量；3. 验证清理完整性|1. 每次操作后临时文件数量不增加；2. 异常情况下也能正确清理；3. 无残留临时文件|最高|
|FUNC-FS-TEMP-004|异常情况下临时文件清理|1. 文件系统工具初始化完成；2. 模拟各种异常|1. 在不同阶段模拟异常（命令失败、进程终止等）；2. 检查临时文件状态；3. 验证清理机制|1. 任何异常情况下临时文件都被清理；2. 清理失败不影响后续操作；3. 提供明确的清理状态反馈|最高|
|FUNC-FS-TEMP-005|多行修改临时文件管理|1. 文件系统工具初始化完成；2. 测试文件存在|1. 执行需要多行修改的操作；2. 检查临时文件创建和清理；3. 验证delete+insert的临时文件管理|1. 多行修改正确使用临时文件；2. 临时文件在操作完成后立即清理；3. 不会因为delete+insert而残留临时文件|高|
|FUNC-FS-TEMP-006|进程退出时资源清理|1. 文件系统工具初始化完成；2. 创建临时文件操作|1. 启动操作过程中强制终止进程；2. 检查进程重启后的临时文件状态；3. 验证资源清理机制|1. 进程退出后所有临时文件被清理；2. 新进程不受旧临时文件影响；3. 资源清理不依赖进程状态|最高|

### 路径和文件系统边界用例 ⚠️ **重要**

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|FUNC-FS-PATH-001|符号链接处理|1. 文件系统工具初始化完成；2. workspace内存在符号链接|1. 创建指向workspace内文件的符号链接；2. 通过符号链接路径操作文件；3. 验证安全性|1. 符号链接被正确解析到真实路径；2. 路径仍在workspace内允许操作；3. 不会绕过安全检查|最高|
|FUNC-FS-PATH-002|循环符号链接处理|1. 文件系统工具初始化完成；2. 存在循环符号链接|1. 创建循环符号链接 A→B→A；2. 尝试操作该链接；3. 验证错误处理|1. 检测到循环引用；2. 抛出适当的异常；3. 不会无限循环|高|
|FUNC-FS-PATH-003|硬链接处理|1. 文件系统工具初始化完成；2. workspace内存在硬链接|1. 创建文件的硬链接；2. 通过硬链接路径操作文件；3. 验证文件状态|1. 硬链接被正确处理；2. 操作作用于实际文件内容；3. 硬链接计数正确更新|中|
|FUNC-FS-PATH-004|设备文件和特殊文件|1. 文件系统工具初始化完成；2. 存在特殊文件类型|1. 尝试操作设备文件、管道等特殊文件；2. 验证安全检查|1. 特殊文件被正确识别；2. 根据安全策略允许或拒绝；3. 不会破坏系统文件|最高|

### 内容编码和字符处理用例

|用例ID|测试项|前置条件|测试步骤|预期结果|特殊字符测试|优先级|
|---|---|---|---|---|---|---|
|FUNC-FS-ENCODING-001|UTF-8编码处理|1. 文件系统工具初始化完成|1. 插入包含各种Unicode字符的内容；2. 验证文件编码正确性|1. 所有Unicode字符正确保存；2. 文件编码为UTF-8；3. 无字符丢失或损坏|emoji、中文、阿拉伯文等|高|
|FUNC-FS-ENCODING-002|无效UTF-8序列|1. 文件系统工具初始化完成；2. 文件包含无效UTF-8|1. 尝试修改包含无效UTF-8的文件；2. 验证处理方式|1. 检测到编码问题；2. 提供明确错误信息；3. 不破坏文件原有内容|二进制内容混合|中|
|FUNC-FS-ENCODING-003|BOM字符处理|1. 文件系统工具初始化完成；2. 文件包含BOM|1. 对包含BOM的文件进行操作；2. 验证BOM处理|1. BOM字符被正确识别；2. 操作后BOM位置正确；3. 不会产生额外BOM|UTF-8/UTF-16 BOM|中|
|FUNC-FS-ENCODING-004|二进制文件保护|1. 文件系统工具初始化完成；2. 存在二进制文件|1. 尝试用文本编辑操作二进制文件；2. 验证保护机制|1. 检测到二进制文件；2. 拒绝文本编辑操作；3. 提供明确警告|可执行文件、图片|最高|

### 常规功能用例

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|FUNC-FS-EDIT-006|单行修改操作|1. 文件系统工具初始化完成；2. workspace内存在测试文件 test.txt（内容：Line 1\nLine 2\nLine 3）|1. 调用 `edit` 方法，修改第2行为"Modified Line 2"；2. 读取文件内容验证|1. 文件内容为"Line 1\nModified Line 2\nLine 3"；2. 使用 `sed c\` 命令直接替换；3. 其他行保持不变|高|
|FUNC-FS-EDIT-007|多行修改操作|1. 文件系统工具初始化完成；2. workspace内存在测试文件 test.txt（内容：Line 1\nLine 2\nLine 3）|1. 调用 `edit` 方法，将第2行修改为多行内容；2. 读取文件内容验证|1. 第2行被多行内容替换；2. 使用临时文件处理多行内容；3. 行号正确处理（delete+insert）|高|

## 4.4 FileSystem 安全用例模板（以"路径越界拦截"为例）

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|SEC-FS-PATH-001|文件系统路径越界拦截|1. 文件系统工具初始化完成；2. workspace为 /tmp/test_ws|1. 调用 `edit` 方法，文件路径为 "/etc/passwd"；2. 查看执行结果|1. 操作被拦截，抛出 `RuntimeError`；2. 日志输出"路径超出workspace"的提示；3. /etc/passwd 文件未被修改|最高|
# 5. 测试环境要求

## 5.1 硬件环境

- CPU：≥2核（支持多线程测试）；

- 内存：≥4GB（避免进程并发时内存不足）；

- 存储：≥10GB（临时根目录与测试文件存储）。

## 5.2 软件环境

|环境类型|具体要求|说明|
|---|---|---|
|操作系统|Linux（Ubuntu 20.04+/CentOS 7+）、macOS（12+）|仅支持类Unix系统，Windows需排除|
|依赖工具|Python 3.12+、pytest 7.0+、loguru 0.7.0+|通过 `uv pip install pytest loguru` 安装|
|基础组件|bash 4.0+、coreutils（含ls、rm、pwd等命令）|系统默认自带，需确保可执行权限|
## 5.3 静态检查要求

所有测试代码编辑完成后，必须执行以下静态检查流程：

### 必需检查

1. **pyright 检查**：确保类型正确性和现代 Python 特性的正确使用

   ```bash
   uv run pyright tasking/tool/terminal.py
   ```

2. **pylint 检查**：确保代码风格、结构和最佳实践

   ```bash
   uv run pylint tasking/tool/terminal.py
   ```

### 检查标准

- **pyright**：必须零错误，警告应评估并修复
- **pylint**：评分 ≥ 8.0/10，关键错误必须修复

### 集成到开发流程

- 每次编辑代码后必须执行上述检查
- 提交前必须确保所有检查通过
- 测试脚本应集成静态检查功能（通过 `quality` 命令执行）

### 测试脚本集成

使用统一的测试脚本 `tests/run_tests.sh` 执行静态检查：

```bash
# 运行 Terminal 模块代码质量检查
./tests/run_tests.sh terminal quality

# 运行 Terminal 模块单元测试
./tests/run_tests.sh terminal unit

# 运行 Terminal 模块完整测试（质量检查 + 单元测试）
./tests/run_tests.sh terminal all
```

# 6. 测试执行策略

## 6.1 执行顺序

1. **基础功能测试**：先验证终端初始化、进程启停等核心功能正常，再进行后续测试；

2. **安全校验测试**：核心测试模块，按“白名单→脚本禁用→禁止命令→路径校验→逃逸拦截”的顺序执行；

3. **并发与异常测试**：最后执行（避免影响基础功能验证）；

4. **兼容性测试**：在不同目标系统上重复上述步骤。

## 6.2 优先级与阻塞规则

- 优先级划分：安全校验模块（最高）> 基础功能模块（高）> 并发与异常模块（中）> 兼容性模块（中）；

- 阻塞规则：若基础功能模块（如进程启动）测试失败，直接阻塞后续所有测试，需优先修复。

## 6.3 缺陷管理

- **严重缺陷（P0）**：安全校验失效（如批量删除未拦截、提权命令放行）、进程崩溃、线程死锁；需立即修复，修复后重新执行全量测试；

- **一般缺陷（P1）**：特殊字符路径切换失败、输出格式异常；需在迭代内修复，修复后执行相关模块测试；

- **轻微缺陷（P2）**：日志提示不清晰、非核心方法注释缺失；可延后修复，不阻塞测试通过。

# 7. 测试交付物

1. **测试用例集**：
   - `test_terminal.py`：LocalTerminal 类的完整测试用例（可直接执行）；
   - `test_filesystem.py`：FileSystem 类的完整测试用例（可直接执行）；

2. **测试报告**：含测试覆盖率（≥90%核心方法）、用例执行结果（通过率）、缺陷清单及修复情况；

3. **问题记录**：未修复缺陷的跟踪表（含用例ID、复现步骤、影响范围）；

4. **环境配置说明**：测试环境的详细部署步骤（用于回归测试）。

# 8. 附则

## 8.1 测试设计原则

1. **隔离性**: 每个测试使用独立的临时工作空间
2. **可重复性**: 使用固定的测试数据，确保结果一致
3. **完整性**: 覆盖所有公共接口和边界情况
4. **安全性**: 验证所有安全约束的正确实现

## 8.2 测试隔离机制

- **环境隔离**: 使用临时目录作为独立工作空间
- **数据隔离**: 测试间不共享临时文件
- **状态隔离**: 每个测试前后清理状态
- **进程隔离**: 确保终端进程正确关闭

## 8.3 错误排查指南 ⚠️ **重要**

### 常见问题及解决方案

#### 8.3.1 sed 命令相关问题

1. **特殊字符未正确转义**
   - 问题: 插入包含 `/ & \` 等字符的内容时 sed 命令失败
   - 解决: 检查 `_escape_sed_content` 方法的转义逻辑
   - 验证: 使用包含特殊字符的测试用例

2. **空文件插入失败** ⚠️ **关键问题**
   - 问题: `sed -i '1r temp_file' target_file` 在空文件上无效
   - 原因: 空文件没有"第 1 行"，sed 无法确定插入位置
   - 解决: 使用 `cat temp_file > target_file` 处理空文件插入
   - 相关测试用例: FUNC-FS-EMPTY-001, FUNC-FS-EMPTY-003

3. **临时文件清理失败**
   - 问题: 临时文件未被正确删除
   - 解决: 检查命令组合中的清理逻辑 `&& rm temp_file`
   - 验证: 确保临时文件路径在 workspace 内

#### 8.3.2 文件操作相关问题

1. **路径越界错误**
   - 问题: 文件操作超出 workspace 范围
   - 解决: 检查 `_resolve_file_path` 方法的路径校验
   - 验证: 使用路径遍历测试用例

2. **权限错误**
   - 问题: 文件权限不足导致操作失败
   - 解决: 确保工作空间有读写权限
   - 验证: 检查临时目录的权限设置

3. **行号越界错误**
   - 问题: 对空文件或小文件执行超出范围的行号操作
   - 解决: 实现正确的行号校验逻辑
   - 相关测试用例: FUNC-FS-EMPTY-004, FUNC-FS-EMPTY-005

#### 8.3.3 性能和资源问题

1. **大文件处理**
   - 问题: 处理大文件时内存或性能问题
   - 解决: 使用流式处理，避免一次性加载大文件
   - 验证: 使用大文件测试用例（FUNC-FS-LARGE-001）

2. **临时文件泄漏**
   - 问题: 异常情况下临时文件未清理
   - 解决: 使用 try-finally 确保清理
   - 验证: 检查测试后临时目录是否清空

### 8.3.4 临时文件和资源清理问题 ⚠️ **关键**

1. **临时文件泄漏**
   - 问题: 操作完成后临时文件未被清理
   - 原因: 命令执行失败导致清理部分未执行、异常处理不当
   - 解决: 确保清理命令在所有路径中执行，使用 try-finally
   - 相关测试用例: FUNC-FS-TEMP-003, FUNC-FS-TEMP-004

2. **异常情况下临时文件残留**
   - 问题: 异常中断时临时文件未被清理
   - 原因: 异常处理逻辑不完整，清理命令未被执行
   - 解决: 实现异常安全的清理机制，确保异常时也能清理
   - 相关测试用例: FUNC-FS-TEMP-004

3. **多行修改临时文件管理**
   - 问题: delete+insert 操作中临时文件管理不当
   - 原因: 复合命令中临时文件清理逻辑有缺陷
   - 解决: 确保每个子操作都有相应的清理逻辑
   - 相关测试用例: FUNC-FS-TEMP-005

4. **进程退出时资源清理**
   - 问题: 进程异常退出时临时文件未被清理
   - 原因: 没有进程级别的资源清理机制
   - 解决: 实现信号处理和atexit清理机制
   - 相关测试用例: FUNC-FS-TEMP-006

5. **临时文件名冲突**
   - 问题: 多个操作使用相同临时文件名
   - 原因: 进程ID生成逻辑错误或时间戳重复
   - 解决: 使用 `os.getpid()` 确保唯一性，添加时间戳或随机数
   - 相关测试用例: FUNC-FS-TEMP-002

6. **临时文件位置错误**
   - 问题: 临时文件创建在 workspace 外
   - 原因: `tempfile` 模块默认使用系统临时目录，移动逻辑失败
   - 解决: 检查文件移动逻辑，确保使用 `shutil.move`，验证移动结果
   - 相关测试用例: FUNC-FS-TEMP-001

### 8.3.5 调试技巧

1. **启用详细日志**: 设置 loguru 为 DEBUG 级别
2. **检查生成的命令**: 打印实际执行的 sed/echo 命令
3. **验证文件状态**: 使用 `ls -la` 和 `cat` 检查文件内容
4. **临时文件调试**: 检查临时文件的创建、内容和清理
5. **资源监控**: 使用 `find . -name ".temp_*"` 检查临时文件状态
6. **手动复现**: 在独立环境中手动执行生成的命令

## 8.4 测试数据管理

- **固定数据**: 使用预定义的测试文本内容
- **动态数据**: 在测试中生成随机的边界情况数据
- **清理策略**: 测试完成后自动清理所有临时文件和目录

## 8.5 文档维护

本文档需随 `LocalTerminal` 和 `FileSystem` 类的迭代同步更新：

1. **新增功能时**: 补充对应的测试范围、用例及执行标准
2. **修复缺陷时**: 更新相关的错误排查指南和测试用例
3. **发现边界情况时**: 立即添加到关键边界情况用例表中
4. **性能优化时**: 更新测试环境要求和性能测试用例

**特别提醒**: 任何涉及文件编辑功能的修改，都必须：
1. **验证空文件处理场景**，避免类似 `sed r` 命令失效的问题
2. **验证临时文件清理机制**，确保所有情况下临时文件都被正确清理
3. **测试异常情况**，确保程序崩溃或异常中断时不会残留临时文件
4. **检查资源泄漏**，特别是长时间运行和多文件操作场景
