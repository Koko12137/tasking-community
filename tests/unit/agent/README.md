# Agent 类测试驱动文档

# 1. 文档概述

## 1.1 文档目的

本文档为 `Agent` 模块（智能体系统）的测试驱动规范，明确"需测试的功能范围、测试用例设计逻辑、执行标准及交付要求"，确保测试覆盖所有核心功能与接口契约，验证 Agent 系统符合设计预期（如接口实现、工作流集成、工具调用、钩子系统等）。

## 1.2 测试对象

测试对象包括基于 `IAgent` 抽象接口实现的 Agent 系统，核心组件包括：

- `IAgent` 接口：定义 Agent 的抽象契约（基础信息、语言模型、工作流管理、工具调用等）；
- `BaseAgent` 类：提供 IAgent 接口的基础实现，包含钩子系统、观察-思考-行动循环；
- `ReAct Agent`：基于 ReAct（Reasoning and Acting）模式的 Agent 实现；
- `Reflect Agent`：基于 Reflect（Reason-Reflect-Reason）循环的 Agent 实现；
- `Orchestrate Agent`：基于编排模式的 Agent 实现。

## 1.3 测试依据

- `IAgent` 抽象接口定义的抽象方法契约；
- `BaseAgent` 类及具体 Agent 实现的设计注释；
- 工作流集成规范（Workflow 接口、状态转换、事件链）；
- 工具调用机制（Tool Service、MCP 协议）。

# 2. 测试目标

1. **接口合规性**：验证 IAgent 接口的完整性和正确性，确保所有抽象方法被正确实现；
2. **功能有效性**：验证 Agent 基础功能（初始化、工作流管理、工具调用、钩子系统）正常可用；
3. **工作流集成**：验证 Agent 与 Workflow 的集成（状态转换、事件处理、动作执行）符合预期；
4. **类型安全性**：验证泛型类型约束和类型注解的正确使用；
5. **异步支持**：验证异步方法的正确实现和并发处理。

# 3. 测试范围

基于 Agent 模块的核心能力，测试范围分为"接口测试模块""基础功能模块""Agent 实现模块"三大类，具体测试项如下：

## 3.1 接口测试模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|接口抽象性验证|1. 验证 IAgent 是抽象基类；2. 验证抽象方法定义；3. 验证接口文档完整性|接口测试|
|方法签名检查|1. 验证所有必需方法的存在和签名；2. 验证泛型类型参数的正确使用；3. 验证返回类型和参数类型|接口测试|
|接口实现验证|1. 验证 BaseAgent 正确实现 IAgent；2. 验证具体 Agent 实现符合接口契约；3. 验证类型约束|接口测试|

## 3.2 基础功能模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|Agent 初始化|1. 基础信息管理（ID、名称、类型）；2. 语言模型管理（LLM 获取和设置）；3. 工具服务初始化；4. 钩子函数列表初始化|功能测试|
|工作流集成|1. Workflow 关联和操作；2. 工作流状态获取；3. 工作流事件处理；4. 工作流生命周期管理|功能测试|
|工具调用机制|1. 工具服务获取和设置；2. 工具调用请求处理；3. 工具调用结果解析；4. 工具调用错误处理|功能测试|
|钩子系统|1. 单次执行钩子（pre_run_once、post_run_once）；2. 观察钩子（pre_observe、post_observe）；3. 思考钩子（pre_think、post_think）；4. 行动钩子（pre_act、post_act）；5. 钩子执行顺序和并发处理|功能测试|
|观察-思考-行动循环|1. Observe 阶段功能；2. Think 阶段功能；3. Act 阶段功能；4. 循环控制和终止条件|功能测试|

## 3.3 Agent 实现模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|ReAct Agent|1. ReAct 工作流状态转换（PROCESSING -> COMPLETED）；2. end_workflow 函数测试；3. 工具调用和标签验证；4. build_react_agent 函数测试|功能测试|
|Reflect Agent|1. Reflect 循环（Reason-Reflect-Reason）；2. 状态管理（REASONING -> REFLECTING -> FINISHED）；3. 工具集成和工作流集成；4. 自定义配置测试|功能测试|
|Orchestrate Agent|1. 编排模式工作流；2. 多阶段协调；3. 复杂场景处理|功能测试|

测试用例需遵循"正向验证+异常处理"原则，即既要验证合法操作正常执行，也要验证异常情况被正确处理。以下为关键测试用例模板（完整用例集可参考配套的测试文件）：

## 4.1 接口测试用例模板（以"接口抽象性验证"为例）

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|IFACE-AGENT-001|IAgent 接口抽象性验证|1. Python 3.12+ 环境；2. 已导入 IAgent 接口|1. 验证 IAgent 是抽象基类（ABC）；2. 检查抽象方法集合；3. 尝试直接实例化 IAgent|1. IAgent 是 ABC 的子类；2. 抽象方法集合包含所有必需方法；3. 直接实例化抛出 TypeError|高|

## 4.2 基础功能用例模板（以"工作流集成"为例）

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|FUNC-WF-001|工作流关联和操作|1. 创建 BaseAgent 实例；2. 创建 MockWorkflow 实例|1. 调用 `set_workflow` 设置工作流；2. 调用 `get_workflow` 获取工作流；3. 验证工作流状态获取|1. 工作流设置成功；2. 获取的工作流与设置的一致；3. 工作流状态正确获取|高|

## 4.3 Agent 实现用例模板（以"ReAct Agent 构建"为例）

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|IMPL-REACT-001|build_react_agent 函数测试|1. 准备 MockLLM 实例；2. 准备工具服务客户端|1. 调用 `build_react_agent` 创建 Agent；2. 验证 Agent 类型和属性；3. 验证工作流配置|1. Agent 创建成功；2. Agent 类型为 ReAct；3. 工作流配置正确|高|

# 5. 测试环境要求

## 5.1 硬件环境

- CPU：≥2核（支持异步测试和并发处理）；
- 内存：≥4GB（避免异步测试时内存不足）；
- 存储：≥5GB（测试数据和临时文件存储）。

## 5.2 软件环境

|环境类型|具体要求|说明|
|---|---|---|
|操作系统|Linux（Ubuntu 20.04+/CentOS 7+）、macOS（12+）、Windows（WSL2）|支持跨平台测试|
|依赖工具|Python 3.12+、pytest 7.0+、pytest-asyncio 0.21.0+|通过 `uv pip install pytest pytest-asyncio` 安装|
|基础组件|uv（推荐）或 python3|用于环境管理和依赖安装|

## 5.3 静态检查要求

所有测试代码编辑完成后，必须执行以下静态检查流程：

### 必需检查

1. **pyright 检查**：确保类型正确性和现代 Python 特性的正确使用

   ```bash
   uv run pyright tasking/core/agent/
   ```

2. **pylint 检查**：确保代码风格、结构和最佳实践

   ```bash
   uv run pylint tasking/core/agent/
   ```

### 检查标准

- **pyright**：必须零错误，警告应评估并修复
- **pylint**：评分 ≥ 8.0/10，关键错误必须修复

### 集成到开发流程

- 每次编辑代码后必须执行上述检查
- 提交前必须确保所有检查通过
- 测试脚本应集成静态检查功能（通过 `quality` 命令执行）

### 测试脚本集成

使用统一的测试脚本 `tests/run_tests.sh` 执行静态检查：

```bash
# 运行 Agent 模块代码质量检查
./tests/run_tests.sh agent quality

# 运行 Agent 模块单元测试
./tests/run_tests.sh agent unit

# 运行 Agent 模块完整测试（质量检查 + 单元测试）
./tests/run_tests.sh agent all
```

# 6. 测试执行策略

## 6.1 执行顺序

1. **接口测试**：先验证 IAgent 接口定义和契约正确，再进行实现测试；
2. **基础功能测试**：验证 BaseAgent 核心功能正常，再进行具体 Agent 实现测试；
3. **Agent 实现测试**：按"ReAct → Reflect → Orchestrate"的顺序执行；
4. **集成测试**：最后执行端到端集成测试。

## 6.2 优先级与阻塞规则

- 优先级划分：接口测试（最高）> 基础功能模块（高）> Agent 实现模块（中）> 集成测试（中）；
- 阻塞规则：若接口测试或基础功能模块（如工作流集成）测试失败，直接阻塞后续所有测试，需优先修复。

## 6.3 缺陷管理

- **严重缺陷（P0）**：接口实现错误、工作流集成失败、工具调用异常；需立即修复，修复后重新执行全量测试；
- **一般缺陷（P1）**：钩子函数执行异常、异步方法错误；需在迭代内修复，修复后执行相关模块测试；
- **轻微缺陷（P2）**：日志提示不清晰、非核心方法注释缺失；可延后修复，不阻塞测试通过。

# 7. 测试交付物

1. **测试用例集**：含完整测试用例的测试文件（`test_interface.py`、`test_base_agent.py`、`test_react.py`、`test_reflect.py` 等，可直接执行）；
2. **测试报告**：含测试覆盖率（≥80%）、用例执行结果（通过率）、缺陷清单及修复情况；
3. **问题记录**：未修复缺陷的跟踪表（含用例ID、复现步骤、影响范围）；
4. **环境配置说明**：测试环境的详细部署步骤（用于回归测试）。

# 8. 附则

本文档需随 Agent 模块的迭代同步更新：若新增 Agent 实现（如新增特定领域的 Agent）或修改接口定义（如新增抽象方法），需补充对应的测试范围、用例及执行标准。

