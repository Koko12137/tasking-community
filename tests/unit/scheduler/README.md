# Scheduler 类测试驱动文档

# 1. 文档概述

## 1.1 文档目的

本文档为 `Scheduler` 模块（调度器系统）的测试驱动规范，明确"需测试的功能范围、测试用例设计逻辑、执行标准及交付要求"，确保测试覆盖所有核心功能与调度逻辑，验证调度器系统符合设计预期（如状态转换、任务调度、回调执行、错误处理等）。

## 1.2 测试对象

测试对象为基于 `IScheduler` 抽象接口实现的调度器系统，核心组件包括：

- `BaseScheduler` 类：提供调度器的基础实现，包含编译逻辑、状态转换、回调执行；
- 调度器构建器：`build_base_scheduler` 函数，用于创建调度器实例；
- 状态转换逻辑：状态机编译规则、循环检测、状态转换验证；
- 工作流执行：任务调度流程、事件处理机制、回调函数执行。

## 1.3 测试依据

- `IScheduler` 抽象接口定义的抽象方法契约；
- `BaseScheduler` 类构造函数及核心方法的设计注释；
- 状态机编译规则（全状态可达性检查、循环检测、转换规则验证）；
- 调度器执行规范（任务调度、事件处理、回调执行）。

# 2. 测试目标

1. **功能有效性**：验证调度器基础功能（初始化、编译、状态转换、任务调度）正常可用；
2. **编译正确性**：验证状态机编译规则（全状态可达性、循环检测、转换规则验证）正确执行；
3. **调度逻辑**：验证任务调度流程（状态监听、事件触发、回调执行）符合预期；
4. **错误处理**：验证调度器对异常情况（无效状态转换、未配置状态、编译失败）的处理符合预期；
5. **集成能力**：验证调度器与 Agent、Task 的集成正常工作。

# 3. 测试范围

基于 Scheduler 模块的核心能力，测试范围分为"基础功能模块""构建器模块""集成测试模块""边界情况模块"四大类，具体测试项如下：

## 3.1 基础功能模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|调度器初始化|1. 默认参数和自定义参数初始化；2. 无效参数的错误处理；3. 结束状态配置；4. 唯一调度器ID生成|功能测试|
|编译逻辑和验证|1. 状态机编译规则（全状态可达性检查）；2. 循环检测和限制；3. 状态转换规则验证；4. 编译状态管理；5. on_state_changed_fn 中有出边的非结束状态必须配置 on_state_fn；6. 运行时验证任务状态与调度器配置的匹配性（任务合法状态必须在调度器配置中，非结束状态必须有 on_state_fn）|功能测试|
|状态转换处理|1. 状态转换规则获取；2. 状态转换执行；3. 转换动作函数执行|功能测试|
|工作流执行|1. 简单的状态转换流程；2. 事件处理机制；3. 回调函数执行；4. 工作流生命周期管理|功能测试|
|边界情况错误处理|1. 无效状态转换处理；2. 未配置的状态处理；3. 异常情况下的错误恢复；4. 编译失败后的状态重置；5. 任务状态与调度器配置不匹配的处理（任务合法状态不在调度器配置中、非结束状态缺少 on_state_fn）|异常测试|

## 3.2 构建器模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|build_base_scheduler 函数|1. 基础调度器创建；2. 参数传递和验证；3. 默认值处理；4. 类型安全检查|功能测试|
|配置验证|1. 调度器参数配置正确性；2. 必需参数和可选参数处理；3. 参数类型验证；4. 配置错误处理|功能测试|

## 3.3 集成测试模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|端到端调度|1. 完整的任务调度流程；2. 多步骤、多状态调度场景；3. 调度器执行效率；4. 长时间运行和大量任务处理|集成测试|
|多任务协作|1. 多个任务的调度协调；2. 并发任务调度处理；3. 任务优先级管理；4. 资源分配和调度|集成测试|
|Agent 和 Task 集成|1. 调度器与 Agent 的集成；2. 调度器与 Task 的集成；3. 完整调度生命周期；4. 复杂场景处理|集成测试|

## 3.4 边界情况模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|异常恢复|1. 调度器异常后的恢复机制；2. 错误后状态恢复；3. 部分初始化处理；4. 编译失败恢复|异常测试|
|边界条件处理|1. 极值和特殊情况处理；2. 空值、空集合处理；3. 最大深度和循环限制；4. 资源限制处理|边界测试|

测试用例需遵循"正向验证+异常处理"原则，即既要验证合法操作正常执行，也要验证异常情况被正确处理。以下为关键测试用例模板（完整用例集可参考配套的测试文件）：

## 4.1 基础功能用例模板（以"调度器初始化"为例）

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|FUNC-INIT-001|默认参数初始化|1. Python 3.12+ 环境；2. 已导入 BaseScheduler|1. 使用默认参数创建 BaseScheduler；2. 验证调度器ID生成；3. 验证默认配置|1. 调度器创建成功；2. 调度器ID唯一；3. 默认配置正确|高|

## 4.2 编译逻辑用例模板（以"全状态可达性检查"为例）

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|COMPILE-REACH-001|全状态可达性检查|1. 创建调度器实例；2. 配置状态和转换规则|1. 设置有效状态集合；2. 设置初始状态和转换规则；3. 调用 compile 方法；4. 验证所有状态可达|1. 编译成功；2. 所有状态从初始状态可达；3. 不可达状态被检测并报错|最高|
|COMPILE-ONSTATE-001|on_state_fn 配置检查|1. 创建调度器实例；2. 配置 on_state_changed_fn|1. 配置有出边的状态转换；2. 不配置对应的 on_state_fn；3. 调用 compile 方法|1. 编译失败；2. 抛出 RuntimeError，提示缺失的 on_state_fn 状态|最高|
|COMPILE-TASKMATCH-001|任务状态与调度器配置匹配检查|1. 创建调度器实例；2. 创建任务实例|1. 配置调度器的 on_state_changed_fn；2. 创建任务，任务的合法状态不在调度器配置中；3. 调用 schedule 方法|1. schedule 失败；2. 抛出 ValueError，提示任务状态与调度器配置不匹配|最高|

## 4.3 集成测试用例模板（以"端到端调度"为例）

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|INTEG-ENDTOEND-001|完整任务调度流程|1. 创建调度器、Agent、Task 实例；2. 配置完整调度流程|1. 初始化调度器；2. 注册任务和Agent；3. 触发调度；4. 验证完整执行流程|1. 调度流程正常执行；2. 状态转换正确；3. 回调函数正确执行；4. 任务完成|高|

# 5. 测试环境要求

## 5.1 硬件环境

- CPU：≥2核（支持异步测试和并发处理）；
- 内存：≥4GB（避免异步测试时内存不足）；
- 存储：≥5GB（测试数据和临时文件存储）。

## 5.2 软件环境

|环境类型|具体要求|说明|
|---|---|---|
|操作系统|Linux（Ubuntu 20.04+/CentOS 7+）、macOS（12+）、Windows（WSL2）|支持跨平台测试|
|依赖工具|Python 3.12+、pytest 7.0+、pytest-asyncio 0.21.0+|通过 `uv pip install pytest pytest-asyncio` 安装|
|基础组件|uv（推荐）或 python3|用于环境管理和依赖安装|

## 5.3 静态检查要求

所有测试代码编辑完成后，必须执行以下静态检查流程：

### 必需检查

1. **pyright 检查**：确保类型正确性和现代 Python 特性的正确使用

   ```bash
   uv run pyright tasking/scheduler/
   ```

2. **pylint 检查**：确保代码风格、结构和最佳实践

   ```bash
   uv run pylint tasking/scheduler/
   ```

### 检查标准

- **pyright**：必须零错误，警告应评估并修复
- **pylint**：评分 ≥ 8.0/10，关键错误必须修复

### 集成到开发流程

- 每次编辑代码后必须执行上述检查
- 提交前必须确保所有检查通过
- 测试脚本应集成静态检查功能（通过 `quality` 命令执行）

### 测试脚本集成

使用统一的测试脚本 `tests/run_tests.sh` 执行静态检查：

```bash
# 运行 Scheduler 模块代码质量检查
./tests/run_tests.sh scheduler quality

# 运行 Scheduler 模块单元测试
./tests/run_tests.sh scheduler unit

# 运行 Scheduler 模块完整测试（质量检查 + 单元测试）
./tests/run_tests.sh scheduler all
```

# 6. 测试执行策略

## 6.1 执行顺序

1. **基础功能测试**：先验证调度器初始化、编译等核心功能正常，再进行后续测试；
2. **构建器测试**：验证调度器构建函数的正确性；
3. **集成测试**：验证调度器与 Agent、Task 的集成；
4. **边界情况测试**：最后执行边界条件和异常处理测试。

## 6.2 优先级与阻塞规则

- 优先级划分：基础功能模块（最高）> 构建器模块（高）> 集成测试模块（中）> 边界情况模块（中）；
- 阻塞规则：若基础功能模块（如调度器初始化、编译）测试失败，直接阻塞后续所有测试，需优先修复。

## 6.3 缺陷管理

- **严重缺陷（P0）**：编译逻辑错误、状态转换失败、调度流程异常；需立即修复，修复后重新执行全量测试；
- **一般缺陷（P1）**：回调函数执行异常、错误处理不完善；需在迭代内修复，修复后执行相关模块测试；
- **轻微缺陷（P2）**：日志提示不清晰、非核心方法注释缺失；可延后修复，不阻塞测试通过。

# 7. 测试交付物

1. **测试用例集**：含完整测试用例的测试文件（`test_scheduler_basic.py`、`test_scheduler_builder.py`、`test_scheduler_integration.py`、`test_scheduler_corner_cases.py` 等，可直接执行）；
2. **测试报告**：含测试覆盖率（≥80%）、用例执行结果（通过率）、缺陷清单及修复情况；
3. **问题记录**：未修复缺陷的跟踪表（含用例ID、复现步骤、影响范围）；
4. **环境配置说明**：测试环境的详细部署步骤（用于回归测试）。

# 8. 附则

本文档需随 Scheduler 模块的迭代同步更新：若新增调度器实现（如新增特定调度策略）或修改调度逻辑（如新增状态转换规则），需补充对应的测试范围、用例及执行标准。

