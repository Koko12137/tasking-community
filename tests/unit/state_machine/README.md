# StateMachine 类测试驱动文档

# 1. 文档概述

## 1.1 文档目的

本文档为 `StateMachine` 模块（状态机系统）的测试驱动规范，明确"需测试的功能范围、测试用例设计逻辑、执行标准及交付要求"，确保测试覆盖所有核心功能与状态管理逻辑，验证状态机系统符合设计预期（如状态转换、编译验证、任务管理、工作流执行等）。

## 1.2 测试对象

测试对象为基于 `IStateMachine` 抽象接口实现的状态机系统，核心组件包括：

- `IStateMachine` 接口：定义状态机的抽象契约（状态管理、转换规则、编译验证等）；
- `BaseStateMachine` 类：提供状态机的基础实现，包含状态生命周期管理、编译时全状态可达性检查；
- `BaseTask` 类：任务状态机扩展，具有扩展功能和输入/输出管理；
- `BaseTreeTaskNode` 类：树形结构任务节点管理，支持层级关系和父子节点操作；
- `BaseWorkflow` 类：工作流状态机实现，支持事件链和动作函数执行。

## 1.3 测试依据

- `IStateMachine` 抽象接口定义的抽象方法契约；
- `BaseStateMachine` 类及扩展类（BaseTask、BaseTreeTaskNode、BaseWorkflow）的设计注释；
- 状态机编译规则（全状态可达性检查、循环检测、转换规则验证）；
- 任务和工作流执行规范（状态转换、事件处理、动作执行）。

# 2. 测试目标

1. **功能有效性**：验证状态机基础功能（初始化、编译、状态转换、事件处理）正常可用；
2. **编译正确性**：验证状态机编译规则（全状态可达性、循环检测、转换规则验证）正确执行；
3. **状态管理**：验证状态机的状态管理（状态获取、转换、重置）符合预期；
4. **任务系统**：验证任务状态机的扩展功能（输入输出、错误处理、树形结构）正常工作；
5. **工作流系统**：验证工作流状态机的执行（事件链、动作函数、标签管理）符合预期；
6. **类型安全**：验证泛型系统和接口兼容性。

# 3. 测试范围

基于 StateMachine 模块的核心能力，测试范围分为"基础功能模块""任务系统模块""工作流系统模块""边界情况模块"四大类，具体测试项如下：

## 3.1 基础功能模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|状态机初始化|1. 有效状态集合设置；2. 初始状态设置；3. 转换规则设置；4. 唯一状态机ID生成|功能测试|
|编译逻辑和验证|1. 状态机编译规则（全状态可达性检查）；2. 循环检测和限制；3. 状态转换规则验证；4. 编译状态管理|功能测试|
|状态转换处理|1. 状态转换规则获取；2. 状态转换执行；3. 转换动作函数执行；4. 状态转换错误处理|功能测试|
|状态重置|1. 状态重置到初始状态；2. 重置后状态验证；3. 重置后转换规则验证；4. 重置后编译状态|功能测试|
|上下文管理|1. 状态上下文存储；2. 状态上下文检索；3. 上下文更新和删除；4. 上下文生命周期管理|功能测试|

## 3.2 任务系统模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|BaseTask 功能|1. 任务属性管理（ID、类型、协议、标签）；2. 输入输出管理；3. 错误处理和恢复；4. 状态访问计数|功能测试|
|BaseTreeTaskNode 功能|1. 树形结构管理（父子节点、层级关系）；2. 深度计算和限制；3. 节点添加和移除；4. 树形结构遍历|功能测试|
|任务状态转换|1. 任务状态转换规则；2. 任务事件处理；3. 任务状态验证；4. 任务状态重置|功能测试|
|任务构建器|1. build_base_tree_node 函数；2. 任务构建参数验证；3. 默认值处理；4. 类型安全检查|功能测试|

## 3.3 工作流系统模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|BaseWorkflow 功能|1. 工作流状态管理；2. 事件链执行；3. 动作函数执行；4. 标签管理|功能测试|
|工作流状态转换|1. 工作流状态转换规则；2. 工作流事件处理；3. 工作流状态验证；4. 工作流生命周期管理|功能测试|
|工作流集成|1. 工作流与 Agent 的集成；2. 工作流与 Task 的集成；3. 完整工作流执行流程；4. 复杂场景处理|集成测试|

## 3.4 边界情况模块

|测试子项|测试内容说明|测试类型|
|---|---|---|
|循环引用检测|1. 简单循环引用检测；2. 自引用检测；3. 深层循环检测；4. 循环引用错误处理|边界测试|
|深度边界测试|1. 最大深度限制；2. 深度一致性验证；3. 深度超限处理；4. 深度重置|边界测试|
|类型安全测试|1. 泛型一致性验证；2. 接口安全验证；3. None 值处理；4. 类型转换错误处理|类型测试|
|错误恢复测试|1. 编译失败恢复；2. 状态一致性验证；3. 部分初始化处理；4. 错误状态重置|异常测试|
|边界条件测试|1. 单状态处理；2. 空转换规则处理；3. 重复操作处理；4. 空值处理|边界测试|

测试用例需遵循"正向验证+异常处理"原则，即既要验证合法操作正常执行，也要验证异常情况被正确处理。以下为关键测试用例模板（完整用例集可参考配套的测试文件）：

## 4.1 基础功能用例模板（以"状态机初始化"为例）

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|FUNC-INIT-001|状态机初始化|1. Python 3.12+ 环境；2. 已导入 BaseStateMachine|1. 创建有效状态集合；2. 设置初始状态；3. 设置转换规则；4. 创建 BaseStateMachine 实例|1. 状态机创建成功；2. 状态机ID唯一；3. 自动编译成功|高|

## 4.2 编译逻辑用例模板（以"全状态可达性检查"为例）

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|COMPILE-REACH-001|全状态可达性检查|1. 创建状态机实例；2. 配置状态和转换规则|1. 设置有效状态集合；2. 设置初始状态和转换规则；3. 调用 compile 方法；4. 验证所有状态可达|1. 编译成功；2. 所有状态从初始状态可达；3. 不可达状态被检测并报错|最高|

## 4.3 边界情况用例模板（以"循环引用检测"为例）

|用例ID|测试项|前置条件|测试步骤|预期结果|优先级|
|---|---|---|---|---|---|
|CORNER-CIRCULAR-001|循环引用检测|1. 创建树形任务节点；2. 配置父子关系|1. 创建父节点和子节点；2. 建立循环引用（子节点指向父节点）；3. 尝试添加循环引用；4. 验证循环检测|1. 循环引用被检测；2. 抛出相应异常；3. 树结构保持一致性|高|

# 5. 测试环境要求

## 5.1 硬件环境

- CPU：≥2核（支持异步测试和并发处理）；
- 内存：≥4GB（避免异步测试时内存不足）；
- 存储：≥5GB（测试数据和临时文件存储）。

## 5.2 软件环境

|环境类型|具体要求|说明|
|---|---|---|
|操作系统|Linux（Ubuntu 20.04+/CentOS 7+）、macOS（12+）、Windows（WSL2）|支持跨平台测试|
|依赖工具|Python 3.12+、pytest 7.0+、pytest-asyncio 0.21.0+|通过 `uv pip install pytest pytest-asyncio` 安装|
|基础组件|uv（推荐）或 python3|用于环境管理和依赖安装|

## 5.3 静态检查要求

所有测试代码编辑完成后，必须执行以下静态检查流程：

### 必需检查

1. **pyright 检查**：确保类型正确性和现代 Python 特性的正确使用

   ```bash
   uv run pyright tasking/core/state_machine/
   ```

2. **pylint 检查**：确保代码风格、结构和最佳实践

   ```bash
   uv run pylint tasking/core/state_machine/
   ```

### 检查标准

- **pyright**：必须零错误，警告应评估并修复
- **pylint**：评分 ≥ 8.0/10，关键错误必须修复

### 集成到开发流程

- 每次编辑代码后必须执行上述检查
- 提交前必须确保所有检查通过
- 测试脚本应集成静态检查功能（通过 `quality` 命令执行）

### 测试脚本集成

使用统一的测试脚本 `tests/run_tests.sh` 执行静态检查：

```bash
# 运行 StateMachine 模块代码质量检查
./tests/run_tests.sh state_machine quality

# 运行 StateMachine 模块单元测试
./tests/run_tests.sh state_machine unit

# 运行 StateMachine 模块完整测试（质量检查 + 单元测试）
./tests/run_tests.sh state_machine all
```

# 6. 测试执行策略

## 6.1 执行顺序

1. **基础功能测试**：先验证状态机初始化、编译等核心功能正常，再进行后续测试；
2. **任务系统测试**：验证 BaseTask 和 BaseTreeTaskNode 的功能；
3. **工作流系统测试**：验证 BaseWorkflow 的功能；
4. **边界情况测试**：最后执行边界条件和异常处理测试。

## 6.2 优先级与阻塞规则

- 优先级划分：基础功能模块（最高）> 任务系统模块（高）> 工作流系统模块（中）> 边界情况模块（中）；
- 阻塞规则：若基础功能模块（如状态机初始化、编译）测试失败，直接阻塞后续所有测试，需优先修复。

## 6.3 缺陷管理

- **严重缺陷（P0）**：编译逻辑错误、状态转换失败、循环引用未检测；需立即修复，修复后重新执行全量测试；
- **一般缺陷（P1）**：任务属性管理异常、工作流执行错误；需在迭代内修复，修复后执行相关模块测试；
- **轻微缺陷（P2）**：日志提示不清晰、非核心方法注释缺失；可延后修复，不阻塞测试通过。

# 7. 测试交付物

1. **测试用例集**：含完整测试用例的测试文件（`test_state_machine.py`、`test_task.py`、`test_tree_task.py`、`test_workflow.py`、`test_corner_cases.py` 等，可直接执行）；
2. **测试报告**：含测试覆盖率（≥80%）、用例执行结果（通过率）、缺陷清单及修复情况；
3. **问题记录**：未修复缺陷的跟踪表（含用例ID、复现步骤、影响范围）；
4. **环境配置说明**：测试环境的详细部署步骤（用于回归测试）。

# 8. 附则

本文档需随 StateMachine 模块的迭代同步更新：若新增状态机实现（如新增特定状态机类型）或修改状态管理逻辑（如新增状态转换规则），需补充对应的测试范围、用例及执行标准。

